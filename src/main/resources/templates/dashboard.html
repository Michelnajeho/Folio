<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}"/>
</head>
<body>
<div layout:fragment="content">

    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <p>트레이딩 현황을 한눈에 확인하세요.</p>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total P&amp;L</div>
            <div class="stat-value">₩0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Return</div>
            <div class="stat-value">-</div>
        </div>
    </div>

    <!-- Activity Row: Balance + Calendar -->
    <div class="activity-section">
        <h2 class="section-title">Activity</h2>
        <div class="activity-row">
            <!-- Total Balance Card -->
            <div class="balance-overview">
                <div class="balance-overview-label">Total Balance</div>
                <div class="balance-overview-value"
                     th:text="${'$' + #numbers.formatDecimal(summary.totalBalance, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                <div class="balance-overview-sub">
                    <span class="balance-overview-accounts"
                          th:text="${summary.accountCount + ' account' + (summary.accountCount != 1 ? 's' : '')}">0 accounts</span>
                </div>
            </div>
            <!-- Calendar -->
            <div class="activity-card">
                <div class="activity-calendar" id="activityCalendar"></div>
                <div class="activity-legend">
                    <span class="activity-legend-label">Less</span>
                    <span class="activity-legend-cell" data-level="0"></span>
                    <span class="activity-legend-cell" data-level="1"></span>
                    <span class="activity-legend-cell" data-level="2"></span>
                    <span class="activity-legend-cell" data-level="3"></span>
                    <span class="activity-legend-cell" data-level="4"></span>
                    <span class="activity-legend-label">More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Trade Calendar -->
    <div class="trade-cal-section">
        <div class="trade-cal-header">
            <h2 class="section-title">Trade Calendar</h2>
            <div class="trade-cal-nav">
                <button class="trade-cal-nav-btn" id="tcPrev" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <span class="trade-cal-month" id="tcMonth">February 2026</span>
                <button class="trade-cal-nav-btn" id="tcNext" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            </div>
        </div>
        <div class="trade-cal-card">
            <div class="trade-cal-grid" id="tradeCalendar"></div>
        </div>
    </div>

    <script>
        (function () {
            var calendar = document.getElementById('activityCalendar');
            if (!calendar) return;

            var DAY_MS = 86400000;
            var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var todayTs = today.getTime();

            /* ── 시작 날짜: 약 52주 전, 일요일로 정렬 ── */
            var start = new Date(todayTs - 364 * DAY_MS);
            start.setDate(start.getDate() - start.getDay()); /* 일요일 정렬 */
            var startTs = start.getTime();

            /* 전체 날짜 배열을 미리 계산 (1일 간격) */
            var days = [];
            for (var ts = startTs; ts <= todayTs + 6 * DAY_MS; ts += DAY_MS) {
                days.push(new Date(ts));
            }

            /* 주(week) 단위로 그룹핑: 7개씩 잘라서 columns */
            var weeks = [];
            for (var i = 0; i < days.length; i += 7) {
                weeks.push(days.slice(i, i + 7));
            }
            var totalWeeks = weeks.length;

            var cellSize = 13;
            var cellGap = 3;
            var colWidth = cellSize + cellGap;

            /* ── 요일 라벨 ── */
            var dayLabels = ['', 'Mon', '', 'Wed', '', 'Fri', ''];

            var html = '<div class="cal-wrapper">';

            html += '<div class="cal-days">';
            for (var d = 0; d < 7; d++) {
                html += '<div class="cal-day-label">' + dayLabels[d] + '</div>';
            }
            html += '</div>';

            html += '<div class="cal-grid-wrapper">';

            /* ── 월 라벨 ── */
            html += '<div class="cal-months">';
            var lastMonth = -1;
            for (var w = 0; w < totalWeeks; w++) {
                var m = weeks[w][0].getMonth();
                if (m !== lastMonth) {
                    html += '<div class="cal-month-label" style="position:absolute;left:' + (w * colWidth) + 'px">' + monthNames[m] + '</div>';
                    lastMonth = m;
                }
            }
            html += '</div>';

            /* ── 셀 그리드 ── */
            /* grid-auto-flow: column → 세로(7칸)를 먼저 채우고 다음 열로 이동 */
            /* 따라서 출력 순서: col(주) → row(요일) */
            html += '<div class="cal-grid">';
            for (var col = 0; col < totalWeeks; col++) {
                for (var row = 0; row < 7; row++) {
                    var cell = weeks[col] && weeks[col][row];
                    if (!cell || cell.getTime() > todayTs) {
                        html += '<div class="cal-cell cal-cell-future"></div>';
                    } else {
                        html += '<div class="cal-cell" data-date="' + fmtDate(cell) + '" data-level="0"></div>';
                    }
                }
            }
            html += '</div></div></div>';

            calendar.innerHTML = html;

            /* ── 툴팁 ── */
            var tooltip = document.createElement('div');
            tooltip.className = 'cal-tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            calendar.addEventListener('mouseover', function (e) {
                var c = e.target.closest('.cal-cell[data-date]');
                if (c) {
                    tooltip.textContent = c.dataset.date;
                    tooltip.style.display = 'block';
                    var r = c.getBoundingClientRect();
                    var tw = tooltip.offsetWidth;
                    var th = tooltip.offsetHeight;
                    var left = r.left + r.width / 2 - tw / 2;
                    var top = r.top - th - 6 + window.scrollY;
                    if (left < 4) left = 4;
                    if (left + tw > window.innerWidth - 4) left = window.innerWidth - tw - 4;
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }
            });

            calendar.addEventListener('mouseout', function (e) {
                if (e.target.closest('.cal-cell')) tooltip.style.display = 'none';
            });

            function fmtDate(d) {
                return monthNames[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
            }
        })();

        /* ══════════════════════════════════
           Trade Calendar (Monthly)
        ══════════════════════════════════ */
        (function () {
            var grid = document.getElementById('tradeCalendar');
            var monthLabel = document.getElementById('tcMonth');
            var prevBtn = document.getElementById('tcPrev');
            var nextBtn = document.getElementById('tcNext');
            if (!grid) return;

            var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            var dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            var now = new Date();
            var viewYear = now.getFullYear();
            var viewMonth = now.getMonth();

            /* ── 임시 데이터: { 'YYYY-MM-DD': { trades: N, pnl: N } } ── */
            var sampleData = {};
            (function generateSample() {
                var y = now.getFullYear();
                var m = now.getMonth();
                /* 이번 달 샘플 */
                var entries = [
                    [1, 3, 520], [2, 1, -180], [4, 2, 340],
                    [5, 4, 1280], [7, 1, -90], [8, 2, 460],
                    [10, 3, -320], [11, 5, 2150], [12, 2, 780],
                    [13, 1, -440], [14, 3, 960]
                ];
                for (var i = 0; i < entries.length; i++) {
                    var key = y + '-' + pad(m + 1) + '-' + pad(entries[i][0]);
                    sampleData[key] = { trades: entries[i][1], pnl: entries[i][2] };
                }
                /* 지난 달 샘플 */
                var pm = m === 0 ? 11 : m - 1;
                var py = m === 0 ? y - 1 : y;
                var prevEntries = [
                    [3, 2, 310], [5, 1, -150], [8, 3, 870],
                    [10, 2, -260], [12, 4, 1540], [15, 1, 220],
                    [18, 3, -680], [20, 2, 430], [22, 5, 2890],
                    [25, 1, -120], [27, 3, 760], [28, 2, -340]
                ];
                for (var j = 0; j < prevEntries.length; j++) {
                    var key2 = py + '-' + pad(pm + 1) + '-' + pad(prevEntries[j][0]);
                    sampleData[key2] = { trades: prevEntries[j][1], pnl: prevEntries[j][2] };
                }
            })();

            function pad(n) { return n < 10 ? '0' + n : '' + n; }

            function render() {
                monthLabel.textContent = monthNames[viewMonth] + ' ' + viewYear;

                var firstDay = new Date(viewYear, viewMonth, 1).getDay();
                var daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
                var today = new Date();
                today.setHours(0, 0, 0, 0);

                var html = '';

                /* 요일 헤더 */
                for (var h = 0; h < 7; h++) {
                    html += '<div class="tc-header">' + dayHeaders[h] + '</div>';
                }

                /* 빈 칸 (1일 이전) */
                for (var b = 0; b < firstDay; b++) {
                    html += '<div class="tc-cell tc-empty"></div>';
                }

                /* 날짜 셀 */
                for (var d = 1; d <= daysInMonth; d++) {
                    var dateKey = viewYear + '-' + pad(viewMonth + 1) + '-' + pad(d);
                    var cellDate = new Date(viewYear, viewMonth, d);
                    var isToday = cellDate.getTime() === today.getTime();
                    var data = sampleData[dateKey];

                    var cls = 'tc-cell';
                    if (isToday) cls += ' tc-today';

                    html += '<div class="' + cls + '">';
                    html += '<span class="tc-day' + (isToday ? ' tc-day-today' : '') + '">' + d + '</span>';

                    if (data) {
                        var pnlCls = data.pnl >= 0 ? 'tc-pnl-pos' : 'tc-pnl-neg';
                        var pnlSign = data.pnl >= 0 ? '+' : '-';
                        html += '<div class="tc-info">';
                        html += '<span class="tc-trades">' + data.trades + ' trade' + (data.trades > 1 ? 's' : '') + '</span>';
                        html += '<span class="' + pnlCls + '">' + pnlSign + '$' + Math.abs(data.pnl).toLocaleString() + '</span>';
                        html += '</div>';
                    }

                    html += '</div>';
                }

                /* 남은 빈 칸 (그리드 채우기) */
                var totalCells = firstDay + daysInMonth;
                var remainder = totalCells % 7;
                if (remainder > 0) {
                    for (var r = 0; r < 7 - remainder; r++) {
                        html += '<div class="tc-cell tc-empty"></div>';
                    }
                }

                grid.innerHTML = html;
            }

            prevBtn.addEventListener('click', function () {
                viewMonth--;
                if (viewMonth < 0) { viewMonth = 11; viewYear--; }
                render();
            });

            nextBtn.addEventListener('click', function () {
                viewMonth++;
                if (viewMonth > 11) { viewMonth = 0; viewYear++; }
                render();
            });

            render();
        })();
    </script>

</div>
</body>
</html>
