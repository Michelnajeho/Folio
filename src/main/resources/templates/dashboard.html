<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}"/>
</head>
<body>
<div layout:fragment="content">

    <div class="dashboard-header">
        <h1 th:text="#{dashboard.title}">Dashboard</h1>
        <p th:text="#{dashboard.subtitle}">트레이딩 현황을 한눈에 확인하세요.</p>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label" th:text="#{dashboard.total_trades}">Total Trades</div>
            <div class="stat-value" th:text="${stats.totalTrades}">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" th:text="#{dashboard.win_rate}">Win Rate</div>
            <div class="stat-value"
                 th:classappend="${stats.winRatePositive ? 'positive' : ''}"
                 th:text="${stats.winRate}">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" th:text="#{dashboard.total_pnl}">Total P&amp;L</div>
            <div class="stat-value"
                 th:classappend="${stats.totalPnlPositive ? 'positive' : 'negative'}"
                 th:text="${stats.totalPnl}">₩0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" th:text="#{dashboard.avg_return}">Avg Return</div>
            <div class="stat-value"
                 th:classappend="${stats.avgReturnPositive ? 'positive' : 'negative'}"
                 th:text="${stats.avgReturn}">-</div>
        </div>
    </div>

    <!-- Activity Row: Balance + Calendar -->
    <div class="activity-section">
        <h2 class="section-title" th:text="#{dashboard.activity}">Activity</h2>
        <div class="activity-row">
            <!-- Total Balance Card -->
            <div class="balance-overview">
                <div class="balance-overview-label" th:text="#{dashboard.total_balance}">Total Balance</div>
                <div class="balance-overview-value"
                     th:text="${'$' + #numbers.formatDecimal(summary.totalBalance, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                <div class="balance-overview-sub">
                    <span class="balance-overview-accounts"
                          th:text="#{dashboard.accounts(${summary.accountCount})}">0 accounts</span>
                </div>
            </div>
            <!-- Calendar -->
            <div class="activity-card">
                <div class="activity-calendar" id="activityCalendar"></div>
                <div class="activity-legend">
                    <span class="activity-legend-label" th:text="#{dashboard.less}">Less</span>
                    <span class="activity-legend-cell" data-level="0"></span>
                    <span class="activity-legend-cell" data-level="1"></span>
                    <span class="activity-legend-cell" data-level="2"></span>
                    <span class="activity-legend-cell" data-level="3"></span>
                    <span class="activity-legend-cell" data-level="4"></span>
                    <span class="activity-legend-label" th:text="#{dashboard.more}">More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Trade Calendar -->
    <div class="trade-cal-section">
        <div class="trade-cal-header">
            <h2 class="section-title" th:text="#{dashboard.trade_calendar}">Trade Calendar</h2>
            <div class="trade-cal-nav">
                <button class="trade-cal-nav-btn" id="tcPrev" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <span class="trade-cal-month" id="tcMonth">February 2026</span>
                <button class="trade-cal-nav-btn" id="tcNext" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            </div>
        </div>
        <div class="trade-cal-card">
            <div class="trade-cal-grid" id="tradeCalendar"></div>
        </div>
    </div>

    <script th:inline="javascript">
        var __lang = /*[[${#locale.language}]]*/ 'ko';

        /* ── 서버에서 전달받은 날짜별 거래 요약 데이터 ── */
        var __dailySummary = /*[[${dailySummary}]]*/ [];

        /* dailySummary → { 'YYYY-MM-DD': { trades: N, pnl: N } } 로 변환 */
        var tradeDataMap = {};
        (function () {
            for (var i = 0; i < __dailySummary.length; i++) {
                var row = __dailySummary[i];
                /* trade_date 는 서버에서 java.sql.Date 또는 String 으로 올 수 있음 */
                var dateStr = String(row.trade_date);
                /* YYYY-MM-DD 형식으로 정규화 */
                if (dateStr.length === 10) {
                    tradeDataMap[dateStr] = {
                        trades: Number(row.trade_count) || 0,
                        pnl: Number(row.daily_pnl) || 0
                    };
                }
            }
        })();

        /* ══════════════════════════════════
           Activity Calendar (Heatmap)
        ══════════════════════════════════ */
        (function () {
            var calendar = document.getElementById('activityCalendar');
            if (!calendar) return;

            var DAY_MS = 86400000;
            var monthNames = __lang === 'ko'
                ? ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월']
                : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var todayTs = today.getTime();

            /* ── 시작 날짜: 약 52주 전, 일요일로 정렬 ── */
            var start = new Date(todayTs - 364 * DAY_MS);
            start.setDate(start.getDate() - start.getDay()); /* 일요일 정렬 */
            var startTs = start.getTime();

            /* 전체 날짜 배열을 미리 계산 (1일 간격) */
            var days = [];
            for (var ts = startTs; ts <= todayTs + 6 * DAY_MS; ts += DAY_MS) {
                days.push(new Date(ts));
            }

            /* 주(week) 단위로 그룹핑: 7개씩 잘라서 columns */
            var weeks = [];
            for (var i = 0; i < days.length; i += 7) {
                weeks.push(days.slice(i, i + 7));
            }
            var totalWeeks = weeks.length;

            var cellSize = 13;
            var cellGap = 3;
            var colWidth = cellSize + cellGap;

            /* ── 히트맵 레벨 계산: 수익 → 초록(+), 손실 → 빨강(-) ── */
            function getLevel(dateKey) {
                var data = tradeDataMap[dateKey];
                if (!data || data.trades === 0) return 0;
                var count = data.trades;
                var intensity = count >= 5 ? 4 : count >= 3 ? 3 : count >= 2 ? 2 : 1;
                /* 손실이면 음수 레벨 반환 → CSS에서 빨간색으로 표시 */
                return data.pnl >= 0 ? intensity : -intensity;
            }

            function toDateKey(d) {
                var y = d.getFullYear();
                var m = d.getMonth() + 1;
                var day = d.getDate();
                return y + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
            }

            /* ── 요일 라벨 ── */
            var dayLabels = __lang === 'ko'
                ? ['', '월', '', '수', '', '금', '']
                : ['', 'Mon', '', 'Wed', '', 'Fri', ''];

            var html = '<div class="cal-wrapper">';

            html += '<div class="cal-days">';
            for (var d = 0; d < 7; d++) {
                html += '<div class="cal-day-label">' + dayLabels[d] + '</div>';
            }
            html += '</div>';

            html += '<div class="cal-grid-wrapper">';

            /* ── 월 라벨 ── */
            html += '<div class="cal-months">';
            var lastMonth = -1;
            for (var w = 0; w < totalWeeks; w++) {
                var m = weeks[w][0].getMonth();
                if (m !== lastMonth) {
                    html += '<div class="cal-month-label" style="position:absolute;left:' + (w * colWidth) + 'px">' + monthNames[m] + '</div>';
                    lastMonth = m;
                }
            }
            html += '</div>';

            /* ── 셀 그리드 ── */
            html += '<div class="cal-grid">';
            for (var col = 0; col < totalWeeks; col++) {
                for (var row = 0; row < 7; row++) {
                    var cell = weeks[col] && weeks[col][row];
                    if (!cell || cell.getTime() > todayTs) {
                        html += '<div class="cal-cell cal-cell-future"></div>';
                    } else {
                        var dateKey = toDateKey(cell);
                        var level = getLevel(dateKey);
                        var data = tradeDataMap[dateKey];
                        var tooltipText = fmtDate(cell);
                        if (data) {
                            var tradeLabel = __lang === 'ko'
                                ? data.trades + '건'
                                : data.trades + ' trade' + (data.trades > 1 ? 's' : '');
                            tooltipText += ' · ' + tradeLabel;
                        }
                        html += '<div class="cal-cell" data-date="' + tooltipText + '" data-level="' + level + '"></div>';
                    }
                }
            }
            html += '</div></div></div>';

            calendar.innerHTML = html;

            /* ── 툴팁 ── */
            var tooltip = document.createElement('div');
            tooltip.className = 'cal-tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            calendar.addEventListener('mouseover', function (e) {
                var c = e.target.closest('.cal-cell[data-date]');
                if (c) {
                    tooltip.textContent = c.dataset.date;
                    tooltip.style.display = 'block';
                    var r = c.getBoundingClientRect();
                    var tw = tooltip.offsetWidth;
                    var th = tooltip.offsetHeight;
                    var left = r.left + r.width / 2 - tw / 2;
                    var top = r.top - th - 6 + window.scrollY;
                    if (left < 4) left = 4;
                    if (left + tw > window.innerWidth - 4) left = window.innerWidth - tw - 4;
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }
            });

            calendar.addEventListener('mouseout', function (e) {
                if (e.target.closest('.cal-cell')) tooltip.style.display = 'none';
            });

            function fmtDate(d) {
                if (__lang === 'ko') {
                    return d.getFullYear() + '년 ' + (d.getMonth() + 1) + '월 ' + d.getDate() + '일';
                }
                return monthNames[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
            }
        })();

        /* ══════════════════════════════════
           Trade Calendar (Monthly)
        ══════════════════════════════════ */
        (function () {
            var grid = document.getElementById('tradeCalendar');
            var monthLabel = document.getElementById('tcMonth');
            var prevBtn = document.getElementById('tcPrev');
            var nextBtn = document.getElementById('tcNext');
            if (!grid) return;

            var monthNames = __lang === 'ko'
                ? ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월']
                : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var dayHeaders = __lang === 'ko'
                ? ['일', '월', '화', '수', '목', '금', '토']
                : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            var now = new Date();
            var viewYear = now.getFullYear();
            var viewMonth = now.getMonth();

            function pad(n) { return n < 10 ? '0' + n : '' + n; }

            function render() {
                monthLabel.textContent = __lang === 'ko'
                    ? viewYear + '년 ' + monthNames[viewMonth]
                    : monthNames[viewMonth] + ' ' + viewYear;

                var firstDay = new Date(viewYear, viewMonth, 1).getDay();
                var daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
                var today = new Date();
                today.setHours(0, 0, 0, 0);

                var html = '';

                /* 요일 헤더 */
                for (var h = 0; h < 7; h++) {
                    html += '<div class="tc-header">' + dayHeaders[h] + '</div>';
                }

                /* 빈 칸 (1일 이전) */
                for (var b = 0; b < firstDay; b++) {
                    html += '<div class="tc-cell tc-empty"></div>';
                }

                /* 날짜 셀 */
                for (var d = 1; d <= daysInMonth; d++) {
                    var dateKey = viewYear + '-' + pad(viewMonth + 1) + '-' + pad(d);
                    var cellDate = new Date(viewYear, viewMonth, d);
                    var isToday = cellDate.getTime() === today.getTime();
                    var data = tradeDataMap[dateKey];

                    var cls = 'tc-cell';
                    if (isToday) cls += ' tc-today';

                    html += '<div class="' + cls + '">';
                    html += '<span class="tc-day' + (isToday ? ' tc-day-today' : '') + '">' + d + '</span>';

                    if (data) {
                        var pnlCls = data.pnl >= 0 ? 'tc-pnl-pos' : 'tc-pnl-neg';
                        var pnlSign = data.pnl >= 0 ? '+' : '-';
                        html += '<div class="tc-info">';
                        var tradeText = __lang === 'ko'
                            ? data.trades + '건'
                            : data.trades + ' trade' + (data.trades > 1 ? 's' : '');
                        html += '<span class="tc-trades">' + tradeText + '</span>';
                        html += '<span class="' + pnlCls + '">' + pnlSign + '$' + Math.abs(data.pnl).toLocaleString() + '</span>';
                        html += '</div>';
                    }

                    html += '</div>';
                }

                /* 남은 빈 칸 (그리드 채우기) */
                var totalCells = firstDay + daysInMonth;
                var remainder = totalCells % 7;
                if (remainder > 0) {
                    for (var r = 0; r < 7 - remainder; r++) {
                        html += '<div class="tc-cell tc-empty"></div>';
                    }
                }

                grid.innerHTML = html;
            }

            prevBtn.addEventListener('click', function () {
                viewMonth--;
                if (viewMonth < 0) { viewMonth = 11; viewYear--; }
                render();
            });

            nextBtn.addEventListener('click', function () {
                viewMonth++;
                if (viewMonth > 11) { viewMonth = 0; viewYear++; }
                render();
            });

            render();
        })();
    </script>

</div>
</body>
</html>
