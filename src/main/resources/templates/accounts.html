<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Accounts</title>
    <link rel="stylesheet" th:href="@{/css/accounts.css}"/>
</head>
<body>
<div layout:fragment="content">

    <div class="acc-header">
        <div class="acc-header-top">
            <div>
                <h1>Accounts</h1>
                <p>계좌를 등록하고 자산을 관리하세요.</p>
            </div>
            <button class="acc-btn-add" type="button" onclick="openAddModal()"
                    th:if="${#lists.size(accounts) > 0 and #lists.size(accounts) < 3}">+ New Account</button>
        </div>
    </div>

    <!-- Summary Cards (계좌가 있을 때만) -->
    <div class="acc-summary" th:if="${#lists.size(accounts) > 0}">
        <div class="acc-summary-card">
            <span class="acc-summary-label">Total Balance</span>
            <span class="acc-summary-value" th:text="${#numbers.formatDecimal(summary.totalBalance, 1, 'COMMA', 2, 'POINT')}">0</span>
        </div>
        <div class="acc-summary-card">
            <span class="acc-summary-label">Accounts</span>
            <span class="acc-summary-value" th:text="${summary.accountCount + ' / 3'}">0</span>
            <span class="acc-summary-sub">active accounts</span>
        </div>
        <div class="acc-summary-card">
            <span class="acc-summary-label">This Month P&amp;L</span>
            <span class="acc-summary-value"
                  th:classappend="${summary.monthlyPnl >= 0 ? 'positive' : 'negative'}"
                  th:text="${(summary.monthlyPnl >= 0 ? '+' : '') + #numbers.formatDecimal(summary.monthlyPnl, 1, 'COMMA', 2, 'POINT')}">0</span>
            <span class="acc-summary-sub">this month</span>
        </div>
    </div>

    <!-- Account Cards (계좌가 있을 때) -->
    <div class="acc-list" th:if="${#lists.size(accounts) > 0}">
        <div class="acc-card" th:each="acc : ${accounts}">
            <div class="acc-card-header">
                <span class="acc-card-name" th:text="${acc.accountName}">Account</span>
                <div class="acc-card-header-right">
                    <span class="acc-card-broker" th:text="${acc.broker}"
                          th:if="${acc.broker != null and !acc.broker.isEmpty()}">Broker</span>
                    <span class="acc-card-currency" th:text="${acc.currency}">USD</span>
                </div>
            </div>
            <div class="acc-card-body"
                 th:with="todayDeposits=${todayMap[acc.id]['deposits']}, todayWithdrawals=${todayMap[acc.id]['withdrawals']}">
                <span class="acc-card-section-label">Today</span>
                <div class="acc-card-row">
                    <span class="acc-card-label">Deposits</span>
                    <span class="acc-card-amount"
                          th:classappend="${todayDeposits > 0 ? 'positive' : ''}"
                          th:text="${todayDeposits > 0 ? '+' + #numbers.formatDecimal(todayDeposits, 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(todayDeposits, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                </div>
                <div class="acc-card-row">
                    <span class="acc-card-label">Withdrawals</span>
                    <span class="acc-card-amount"
                          th:classappend="${todayWithdrawals > 0 ? 'negative' : ''}"
                          th:text="${todayWithdrawals > 0 ? '-' + #numbers.formatDecimal(todayWithdrawals, 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(todayWithdrawals, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                </div>
                <div class="acc-card-row">
                    <span class="acc-card-label">Trading P&amp;L</span>
                    <span class="acc-card-amount">0.00</span>
                </div>
                <div class="acc-card-divider"></div>
                <div class="acc-card-row acc-card-total">
                    <span class="acc-card-label">Balance</span>
                    <span class="acc-card-amount" th:text="${#numbers.formatDecimal(acc.balance, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                </div>
            </div>
            <div class="acc-card-footer">
                <button class="acc-card-btn" type="button"
                        th:attr="onclick='openTxModal(' + ${acc.id} + ', \'' + ${acc.accountName} + '\', \'' + ${acc.currency} + '\')'">Deposit / Withdraw</button>
                <a class="acc-card-btn secondary" th:href="@{/accounts/{id}(id=${acc.id})}">Details</a>
            </div>
        </div>
    </div>

    <!-- Empty State (계좌가 없을 때) -->
    <div class="acc-empty" th:if="${#lists.size(accounts) == 0}">
        <div class="acc-empty-icon">
            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="5" width="20" height="14" rx="2"/>
                <line x1="2" y1="10" x2="22" y2="10"/>
            </svg>
        </div>
        <p>아직 등록된 계좌가 없습니다.</p>
        <span class="acc-empty-sub">새 계좌를 등록하고 트레이딩 기록을 시작하세요.</span>
        <button class="acc-empty-btn" type="button" onclick="openAddModal()">+ New Account</button>
    </div>

    <!-- Add Account Modal -->
    <div class="acc-modal-overlay" id="addAccountModal">
        <div class="acc-modal">
            <div class="acc-modal-header">
                <h2>New Account</h2>
                <button class="acc-modal-close" type="button" onclick="closeAddModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="acc-modal-form" id="addAccountForm" onsubmit="return submitAccount(event)">
                <div class="acc-form-group">
                    <label for="accountName">Account Name <span class="required">*</span></label>
                    <input type="text" id="accountName" name="accountName" placeholder="예: Binance Futures" required />
                    <span class="acc-form-error" id="accountNameError"></span>
                </div>
                <div class="acc-form-group">
                    <label for="broker">Broker</label>
                    <input type="text" id="broker" name="broker" placeholder="예: Binance" />
                </div>
                <div class="acc-form-group">
                    <label for="currency">Currency <span class="required">*</span></label>
                    <select id="currency" name="currency" required>
                        <option value="USD">USD</option>
                        <option value="KRW">KRW</option>
                        <option value="USDT">USDT</option>
                        <option value="EUR">EUR</option>
                        <option value="JPY">JPY</option>
                        <option value="BTC">BTC</option>
                    </select>
                </div>
                <div class="acc-modal-footer">
                    <button class="acc-modal-btn cancel" type="button" onclick="closeAddModal()">Cancel</button>
                    <button class="acc-modal-btn submit" type="submit" id="submitBtn">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Feedback Modal -->
    <div class="acc-modal-overlay" id="successModal">
        <div class="acc-modal acc-success-modal">
            <div class="acc-success-body">
                <div class="acc-success-icon">
                    <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="8 12 11 15 16 9"/>
                    </svg>
                </div>
                <p class="acc-success-message" id="successMessage">완료되었습니다.</p>
            </div>
        </div>
    </div>

    <!-- Deposit / Withdraw Modal -->
    <div class="acc-modal-overlay" id="txModal">
        <div class="acc-modal">
            <div class="acc-modal-header">
                <h2>Deposit / Withdraw</h2>
                <button class="acc-modal-close" type="button" onclick="closeTxModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="acc-modal-form" id="txForm" onsubmit="return submitTransaction(event)">
                <input type="hidden" id="txAccountId" />
                <div class="acc-form-group acc-tx-account-info">
                    <label>Account</label>
                    <span class="acc-tx-account-name" id="txAccountName">-</span>
                </div>
                <div class="acc-form-group">
                    <label for="txType">Type <span class="required">*</span></label>
                    <select id="txType" name="type" required>
                        <option value="DEPOSIT">Deposit (입금)</option>
                        <option value="WITHDRAWAL">Withdrawal (출금)</option>
                    </select>
                </div>
                <div class="acc-form-group">
                    <label for="txAmount">Amount <span class="required">*</span></label>
                    <div class="acc-tx-amount-wrap">
                        <input type="number" id="txAmount" name="amount" placeholder="0.00" step="0.01" min="0.01" required />
                        <span class="acc-tx-currency" id="txCurrency">USD</span>
                    </div>
                </div>
                <div class="acc-form-group">
                    <label for="txMemo">Memo</label>
                    <input type="text" id="txMemo" name="memo" placeholder="메모 (선택)" maxlength="200" />
                </div>
                <div class="acc-modal-footer">
                    <button class="acc-modal-btn cancel" type="button" onclick="closeTxModal()">Cancel</button>
                    <button class="acc-modal-btn submit" type="submit" id="txSubmitBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    /* ── Modal Open / Close ── */
    function openAddModal() {
        var modal = document.getElementById('addAccountModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(function () {
            document.getElementById('accountName').focus();
        }, 200);
    }

    function closeAddModal() {
        var modal = document.getElementById('addAccountModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('addAccountForm').reset();
        document.getElementById('accountNameError').textContent = '';
    }

    /* ── Overlay click to close ── */
    document.getElementById('addAccountModal').addEventListener('click', function (e) {
        if (e.target === this) closeAddModal();
    });

    /* ── ESC key to close ── */
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            var addModal = document.getElementById('addAccountModal');
            var txModalEl = document.getElementById('txModal');
            if (txModalEl.classList.contains('active')) closeTxModal();
            else if (addModal.classList.contains('active')) closeAddModal();
        }
    });

    /* ── Account Name duplicate check ── */
    var nameCheckTimer = null;
    var isNameAvailable = true;

    document.getElementById('accountName').addEventListener('input', function () {
        var name = this.value.trim();
        var errorEl = document.getElementById('accountNameError');

        if (nameCheckTimer) clearTimeout(nameCheckTimer);

        if (!name) {
            errorEl.textContent = '';
            isNameAvailable = true;
            return;
        }

        nameCheckTimer = setTimeout(function () {
            fetch('/api/account/check-name?accountName=' + encodeURIComponent(name))
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    if (data.data && !data.data.available) {
                        errorEl.textContent = '이미 동일한 이름의 계좌가 존재합니다.';
                        isNameAvailable = false;
                    } else {
                        errorEl.textContent = '';
                        isNameAvailable = true;
                    }
                });
        }, 300);
    });

    /* ── Form Submit → API ── */
    var isCreateSubmitting = false;

    function submitAccount(e) {
        e.preventDefault();
        if (isCreateSubmitting) return false;

        if (!isNameAvailable) {
            document.getElementById('accountNameError').textContent = '이미 동일한 이름의 계좌가 존재합니다.';
            document.getElementById('accountName').focus();
            return false;
        }

        isCreateSubmitting = true;
        var submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        var body = {
            accountName: document.getElementById('accountName').value.trim(),
            broker: document.getElementById('broker').value.trim() || null,
            currency: document.getElementById('currency').value
        };

        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        var headers = { 'Content-Type': 'application/json' };
        headers[csrfHeader] = csrfToken;

        fetch('/api/account', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        })
        .then(function (res) { return res.json(); })
        .then(function (data) {
            if (data.success) {
                closeAddModal();
                showSuccessModal('계좌가 생성되었습니다.', function () {
                    window.location.reload();
                });
            } else {
                alert(data.message || '계좌 등록에 실패했습니다.');
                isCreateSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        })
        .catch(function () {
            alert('서버 오류가 발생했습니다.');
            isCreateSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        });

        return false;
    }

    /* ══════════════════════════════════
       Success Feedback Modal
    ══════════════════════════════════ */
    var isReloading = false;

    function showSuccessModal(message, callback) {
        var modal = document.getElementById('successModal');
        document.getElementById('successMessage').textContent = message;
        modal.classList.add('active');
        setTimeout(function () {
            modal.classList.remove('active');
            if (callback && !isReloading) {
                isReloading = true;
                callback();
            }
        }, 1200);
    }

    /* ══════════════════════════════════
       Deposit / Withdraw Modal
    ══════════════════════════════════ */
    function openTxModal(accountId, accountName, currency) {
        document.getElementById('txAccountId').value = accountId;
        document.getElementById('txAccountName').textContent = accountName;
        document.getElementById('txCurrency').textContent = currency;
        document.getElementById('txType').value = 'DEPOSIT';
        document.getElementById('txAmount').value = '';
        document.getElementById('txMemo').value = '';
        document.getElementById('txSubmitBtn').disabled = false;
        document.getElementById('txSubmitBtn').textContent = 'Confirm';

        var modal = document.getElementById('txModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(function () {
            document.getElementById('txAmount').focus();
        }, 200);
    }

    function closeTxModal() {
        var modal = document.getElementById('txModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('txForm').reset();
    }

    /* Overlay click to close */
    document.getElementById('txModal').addEventListener('click', function (e) {
        if (e.target === this) closeTxModal();
    });

    /* Transaction Submit */
    var isTxSubmitting = false;

    function submitTransaction(e) {
        e.preventDefault();
        if (isTxSubmitting) return false;

        isTxSubmitting = true;
        var submitBtn = document.getElementById('txSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        var accountId = document.getElementById('txAccountId').value;
        var type = document.getElementById('txType').value;

        var body = {
            type: type,
            amount: parseFloat(document.getElementById('txAmount').value),
            memo: document.getElementById('txMemo').value.trim() || null
        };

        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        var headers = { 'Content-Type': 'application/json' };
        headers[csrfHeader] = csrfToken;

        fetch('/api/account/' + accountId + '/transaction', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        })
        .then(function (res) { return res.json(); })
        .then(function (data) {
            if (data.success) {
                var msg = type === 'DEPOSIT' ? '입금이 완료되었습니다.' : '출금이 완료되었습니다.';
                closeTxModal();
                showSuccessModal(msg, function () {
                    window.location.reload();
                });
            } else {
                alert(data.message || '처리에 실패했습니다.');
                isTxSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirm';
            }
        })
        .catch(function () {
            alert('서버 오류가 발생했습니다.');
            isTxSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Confirm';
        });

        return false;
    }
    </script>

</div>

</body>
</html>
