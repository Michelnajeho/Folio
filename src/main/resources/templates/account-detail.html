<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <link rel="stylesheet" th:href="@{/css/account-detail.css}"/>
</head>
<body>
<div layout:fragment="content">

    <!-- Header -->
    <div class="acd-header">
        <div class="acd-header-top">
            <a th:href="@{/accounts}" class="acd-back">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                <span th:text="#{account_detail.back}">Accounts</span>
            </a>
        </div>
        <div class="acd-header-main">
            <h1 th:text="${account.accountName}">Account Name</h1>
            <div class="acd-header-badges">
                <span class="acd-badge broker" th:if="${account.broker != null and !account.broker.isEmpty()}" th:text="${account.broker}">Broker</span>
                <span class="acd-badge currency" th:text="${account.currency}">USD</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="acd-stats">
        <div class="acd-stat-card highlight">
            <span class="acd-stat-label" th:text="#{account_detail.balance}">Balance</span>
            <span class="acd-stat-value large" th:text="${#numbers.formatDecimal(account.balance, 1, 'COMMA', 2, 'POINT')}">0.00</span>
        </div>
        <div class="acd-stat-card">
            <span class="acd-stat-label" th:text="#{account_detail.today_deposits}">Today Deposits</span>
            <span class="acd-stat-value"
                  th:classappend="${todaySummary['deposits'] > 0 ? 'positive' : ''}"
                  th:text="${todaySummary['deposits'] > 0 ? '+' + #numbers.formatDecimal(todaySummary['deposits'], 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(todaySummary['deposits'], 1, 'COMMA', 2, 'POINT')}">0.00</span>
        </div>
        <div class="acd-stat-card">
            <span class="acd-stat-label" th:text="#{account_detail.today_withdrawals}">Today Withdrawals</span>
            <span class="acd-stat-value"
                  th:classappend="${todaySummary['withdrawals'] > 0 ? 'negative' : ''}"
                  th:text="${todaySummary['withdrawals'] > 0 ? '-' + #numbers.formatDecimal(todaySummary['withdrawals'], 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(todaySummary['withdrawals'], 1, 'COMMA', 2, 'POINT')}">0.00</span>
        </div>
        <div class="acd-stat-card">
            <span class="acd-stat-label" th:text="#{account_detail.total_deposits}">Total Deposits</span>
            <span class="acd-stat-value"
                  th:classappend="${totalSummary['deposits'] > 0 ? 'positive' : ''}"
                  th:text="${totalSummary['deposits'] > 0 ? '+' + #numbers.formatDecimal(totalSummary['deposits'], 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(totalSummary['deposits'], 1, 'COMMA', 2, 'POINT')}">0.00</span>
        </div>
        <div class="acd-stat-card">
            <span class="acd-stat-label" th:text="#{account_detail.total_withdrawals}">Total Withdrawals</span>
            <span class="acd-stat-value"
                  th:classappend="${totalSummary['withdrawals'] > 0 ? 'negative' : ''}"
                  th:text="${totalSummary['withdrawals'] > 0 ? '-' + #numbers.formatDecimal(totalSummary['withdrawals'], 1, 'COMMA', 2, 'POINT') : #numbers.formatDecimal(totalSummary['withdrawals'], 1, 'COMMA', 2, 'POINT')}">0.00</span>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="acd-actions">
        <div class="acd-actions-left">
            <button class="acd-btn primary" type="button" onclick="openTxModal()" th:text="#{accounts.deposit_withdraw}">Deposit / Withdraw</button>
            <button class="acd-btn" type="button" onclick="openEditModal()" th:text="#{account_detail.edit}">Edit</button>
        </div>
        <div class="acd-actions-right">
            <button class="acd-btn danger" type="button" onclick="deleteAccount()" th:text="#{account_detail.delete}">Delete</button>
        </div>
    </div>

    <!-- Transaction History Table -->
    <div class="acd-section">
        <h2 class="acd-section-title" th:text="#{account_detail.tx_history}">Transaction History</h2>

        <div class="acd-table-wrap" th:if="${#lists.size(transactions) > 0}">
            <table class="acd-table">
                <thead>
                <tr>
                    <th th:text="#{account_detail.col_date}">Date</th>
                    <th th:text="#{account_detail.col_type}">Type</th>
                    <th th:text="#{account_detail.col_amount}">Amount</th>
                    <th th:text="#{account_detail.col_memo}">Memo</th>
                    <th class="acd-th-action"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tx : ${transactions}">
                    <td th:text="${#temporals.format(tx.transactedAtKst, 'yyyy-MM-dd HH:mm')}">2026-02-15 14:30</td>
                    <td>
                        <span class="acd-type-badge"
                              th:classappend="${tx.type == 'DEPOSIT' ? 'deposit' : 'withdrawal'}"
                              th:text="${tx.type == 'DEPOSIT'} ? #{accounts.tx.deposit} : #{accounts.tx.withdrawal}">Deposit</span>
                    </td>
                    <td th:classappend="${tx.type == 'DEPOSIT' ? 'positive' : 'negative'}"
                        th:text="${(tx.type == 'DEPOSIT' ? '+' : '-') + #numbers.formatDecimal(tx.amount, 1, 'COMMA', 2, 'POINT')}">+1,000.00</td>
                    <td class="acd-memo" th:text="${tx.memo != null ? tx.memo : '-'}">-</td>
                    <td class="acd-td-action">
                        <button class="acd-edit-btn" type="button"
                                th:data-id="${tx.id}"
                                th:data-type="${tx.type}"
                                th:data-amount="${tx.amount}"
                                th:data-memo="${tx.memo != null ? tx.memo : ''}">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button class="acd-delete-btn" type="button"
                                th:data-id="${tx.id}">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div class="acd-empty" th:if="${#lists.size(transactions) == 0}">
            <svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
            </svg>
            <p th:text="#{account_detail.empty_title}">아직 입출금 내역이 없습니다.</p>
            <span th:text="#{account_detail.empty_sub}">Deposit / Withdraw 버튼으로 첫 거래를 기록하세요.</span>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="acc-modal-overlay" id="editAccountModal">
        <div class="acc-modal">
            <div class="acc-modal-header">
                <h2 th:text="#{account_detail.edit_title}">Edit Account</h2>
                <button class="acc-modal-close" type="button" onclick="closeEditModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="acc-modal-form" id="editAccountForm" onsubmit="return submitEditAccount(event)">
                <input type="hidden" id="editAccountId" th:value="${account.id}" />
                <div class="acc-form-group">
                    <label for="editAccountName" th:text="#{accounts.modal.account_name} + ' *'">Account Name *</label>
                    <input type="text" id="editAccountName" name="accountName" th:value="${account.accountName}" required />
                    <span class="acc-form-error" id="editAccountNameError"></span>
                </div>
                <div class="acc-form-group">
                    <label for="editBroker" th:text="#{accounts.modal.broker}">Broker</label>
                    <input type="text" id="editBroker" name="broker" th:value="${account.broker}" />
                </div>
                <div class="acc-form-group">
                    <label for="editCurrency" th:text="#{accounts.modal.currency} + ' *'">Currency *</label>
                    <select id="editCurrency" name="currency" required>
                        <option value="USD" th:selected="${account.currency == 'USD'}">USD</option>
                        <option value="KRW" th:selected="${account.currency == 'KRW'}">KRW</option>
                        <option value="USDT" th:selected="${account.currency == 'USDT'}">USDT</option>
                        <option value="EUR" th:selected="${account.currency == 'EUR'}">EUR</option>
                        <option value="JPY" th:selected="${account.currency == 'JPY'}">JPY</option>
                        <option value="BTC" th:selected="${account.currency == 'BTC'}">BTC</option>
                    </select>
                </div>
                <div class="acc-modal-footer">
                    <button class="acc-modal-btn cancel" type="button" onclick="closeEditModal()" th:text="#{accounts.modal.cancel}">Cancel</button>
                    <button class="acc-modal-btn submit" type="submit" id="editSubmitBtn" th:text="#{account_detail.save}">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deposit / Withdraw Modal -->
    <div class="acc-modal-overlay" id="txModal">
        <div class="acc-modal">
            <div class="acc-modal-header">
                <h2 th:text="#{accounts.tx.title}">Deposit / Withdraw</h2>
                <button class="acc-modal-close" type="button" onclick="closeTxModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="acc-modal-form" id="txForm" onsubmit="return submitTransaction(event)">
                <input type="hidden" id="txAccountId" th:value="${account.id}" />
                <div class="acc-form-group acc-tx-account-info">
                    <label th:text="#{accounts.tx.account}">Account</label>
                    <span class="acc-tx-account-name" th:text="${account.accountName}">-</span>
                </div>
                <div class="acc-form-group">
                    <label for="txType" th:text="#{accounts.tx.type} + ' *'">Type *</label>
                    <select id="txType" name="type" required>
                        <option value="DEPOSIT" th:text="#{accounts.tx.deposit}">Deposit</option>
                        <option value="WITHDRAWAL" th:text="#{accounts.tx.withdrawal}">Withdrawal</option>
                    </select>
                </div>
                <div class="acc-form-group">
                    <label for="txAmount" th:text="#{accounts.tx.amount} + ' *'">Amount *</label>
                    <div class="acc-tx-amount-wrap">
                        <input type="number" id="txAmount" name="amount" placeholder="0.00" step="0.01" min="0.01" required />
                        <span class="acc-tx-currency" th:text="${account.currency}">USD</span>
                    </div>
                </div>
                <div class="acc-form-group">
                    <label for="txMemo" th:text="#{accounts.tx.memo}">Memo</label>
                    <input type="text" id="txMemo" name="memo" th:placeholder="#{accounts.tx.memo_placeholder}" maxlength="200" />
                </div>
                <div class="acc-modal-footer">
                    <button class="acc-modal-btn cancel" type="button" onclick="closeTxModal()" th:text="#{accounts.modal.cancel}">Cancel</button>
                    <button class="acc-modal-btn submit" type="submit" id="txSubmitBtn" th:text="#{accounts.tx.confirm}">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="acc-modal-overlay" id="txEditModal">
        <div class="acc-modal">
            <div class="acc-modal-header">
                <h2 th:text="#{account_detail.tx_edit_title}">Edit Transaction</h2>
                <button class="acc-modal-close" type="button" onclick="closeTxEditModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="acc-modal-form" id="txEditForm" onsubmit="return submitTxEdit(event)">
                <input type="hidden" id="txEditId" />
                <div class="acc-form-group">
                    <label for="txEditType" th:text="#{accounts.tx.type} + ' *'">Type *</label>
                    <select id="txEditType" name="type" required>
                        <option value="DEPOSIT" th:text="#{accounts.tx.deposit}">Deposit</option>
                        <option value="WITHDRAWAL" th:text="#{accounts.tx.withdrawal}">Withdrawal</option>
                    </select>
                </div>
                <div class="acc-form-group">
                    <label for="txEditAmount" th:text="#{accounts.tx.amount} + ' *'">Amount *</label>
                    <div class="acc-tx-amount-wrap">
                        <input type="number" id="txEditAmount" name="amount" placeholder="0.00" step="0.01" min="0.01" required />
                        <span class="acc-tx-currency" th:text="${account.currency}">USD</span>
                    </div>
                </div>
                <div class="acc-form-group">
                    <label for="txEditMemo" th:text="#{accounts.tx.memo}">Memo</label>
                    <input type="text" id="txEditMemo" name="memo" th:placeholder="#{accounts.tx.memo_placeholder}" maxlength="200" />
                </div>
                <div class="acc-modal-footer">
                    <button class="acc-modal-btn cancel" type="button" onclick="closeTxEditModal()" th:text="#{accounts.modal.cancel}">Cancel</button>
                    <button class="acc-modal-btn submit" type="submit" id="txEditSubmitBtn" th:text="#{account_detail.save}">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
    var accountId = /*[[${account.id}]]*/ 0;

    var MSG = {
        nameDuplicate: /*[[#{accounts.msg.name_duplicate}]]*/ '',
        serverError: /*[[#{accounts.msg.server_error}]]*/ '',
        saveBtn: /*[[#{account_detail.save}]]*/ '',
        savingBtn: /*[[#{account_detail.saving}]]*/ '',
        updated: /*[[#{account_detail.msg.updated}]]*/ '',
        updateFailed: /*[[#{account_detail.msg.update_failed}]]*/ '',
        deleteConfirmTitle: /*[[#{account_detail.delete_confirm_title}]]*/ '',
        deleteConfirmDesc: /*[[#{account_detail.delete_confirm_desc}]]*/ '',
        deleted: /*[[#{account_detail.msg.deleted}]]*/ '',
        deleteFailed: /*[[#{account_detail.msg.delete_failed}]]*/ '',
        confirmBtn: /*[[#{accounts.tx.confirm}]]*/ '',
        processingBtn: /*[[#{accounts.tx.processing}]]*/ '',
        depositDone: /*[[#{accounts.msg.deposit_done}]]*/ '',
        withdrawalDone: /*[[#{accounts.msg.withdrawal_done}]]*/ '',
        txFailed: /*[[#{accounts.msg.tx_failed}]]*/ '',
        txEditTitle: /*[[#{account_detail.tx_edit_title}]]*/ '',
        txUpdated: /*[[#{account_detail.msg.tx_updated}]]*/ '',
        txUpdateFailed: /*[[#{account_detail.msg.tx_update_failed}]]*/ '',
        txDeleteTitle: /*[[#{account_detail.tx_delete_title}]]*/ '',
        txDeleteDesc: /*[[#{account_detail.tx_delete_desc}]]*/ '',
        txDeleted: /*[[#{account_detail.msg.tx_deleted}]]*/ '',
        txDeleteFailed: /*[[#{account_detail.msg.tx_delete_failed}]]*/ '',
        deleteBtn: /*[[#{account_detail.delete}]]*/ ''
    };

    var isReloading = false;
    function showSuccessAndReload(message, callback) {
        showAlert({ type: 'success', message: message, duration: 1200 });
        setTimeout(function () {
            if (callback && !isReloading) { isReloading = true; callback(); }
        }, 1200);
    }

    /* ══ Edit Account Modal ══ */
    var editOriginalName = /*[[${account.accountName}]]*/ '';
    var isEditNameAvailable = true;
    var editNameCheckTimer = null;

    function openEditModal() {
        isEditNameAvailable = true;
        document.getElementById('editAccountNameError').textContent = '';
        document.getElementById('editAccountModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(function () { document.getElementById('editAccountName').focus(); }, 200);
    }
    function closeEditModal() {
        document.getElementById('editAccountModal').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('editAccountNameError').textContent = '';
    }
    document.getElementById('editAccountModal').addEventListener('click', function (e) { if (e.target === this) closeEditModal(); });

    document.getElementById('editAccountName').addEventListener('input', function () {
        var name = this.value.trim();
        var errorEl = document.getElementById('editAccountNameError');
        if (editNameCheckTimer) clearTimeout(editNameCheckTimer);
        if (!name || name === editOriginalName) { errorEl.textContent = ''; isEditNameAvailable = true; return; }
        editNameCheckTimer = setTimeout(function () {
            fetch('/api/account/check-name?accountName=' + encodeURIComponent(name))
                .then(function (r) { return r.json(); })
                .then(function (d) {
                    if (d.data && !d.data.available) { errorEl.textContent = MSG.nameDuplicate; isEditNameAvailable = false; }
                    else { errorEl.textContent = ''; isEditNameAvailable = true; }
                });
        }, 300);
    });

    var isEditSubmitting = false;
    function submitEditAccount(e) {
        e.preventDefault();
        if (isEditSubmitting) return false;
        if (!isEditNameAvailable) { document.getElementById('editAccountNameError').textContent = MSG.nameDuplicate; document.getElementById('editAccountName').focus(); return false; }
        isEditSubmitting = true;
        var btn = document.getElementById('editSubmitBtn'); btn.disabled = true; btn.textContent = MSG.savingBtn;
        var body = { accountName: document.getElementById('editAccountName').value.trim(), broker: document.getElementById('editBroker').value.trim() || null, currency: document.getElementById('editCurrency').value };
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        var headers = { 'Content-Type': 'application/json' }; headers[csrfHeader] = csrfToken;
        fetch('/api/account/' + accountId, { method: 'PUT', headers: headers, body: JSON.stringify(body) })
        .then(function (r) { return r.json(); })
        .then(function (d) {
            if (d.success) { closeEditModal(); showSuccessAndReload(MSG.updated, function () { window.location.reload(); }); }
            else { showAlert(d.message || MSG.updateFailed); isEditSubmitting = false; btn.disabled = false; btn.textContent = MSG.saveBtn; }
        }).catch(function () { showAlert(MSG.serverError); isEditSubmitting = false; btn.disabled = false; btn.textContent = MSG.saveBtn; });
        return false;
    }

    /* ══ Delete Account ══ */
    function deleteAccount() {
        showConfirm({ title: MSG.deleteConfirmTitle, description: MSG.deleteConfirmDesc, icon: 'danger', confirmText: MSG.deleteBtn, confirmClass: 'danger',
            onConfirm: function () {
                var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                var headers = {}; headers[csrfHeader] = csrfToken;
                fetch('/api/account/' + accountId, { method: 'DELETE', headers: headers })
                .then(function (r) { return r.json(); })
                .then(function (d) { if (d.success) { showSuccessAndReload(MSG.deleted, function () { window.location.href = '/accounts'; }); } else { showAlert(d.message || MSG.deleteFailed); } })
                .catch(function () { showAlert(MSG.serverError); });
            }
        });
    }

    /* ══ Deposit / Withdraw Modal ══ */
    function openTxModal() {
        document.getElementById('txType').value = 'DEPOSIT';
        document.getElementById('txAmount').value = '';
        document.getElementById('txMemo').value = '';
        document.getElementById('txSubmitBtn').disabled = false;
        document.getElementById('txSubmitBtn').textContent = MSG.confirmBtn;
        document.getElementById('txModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(function () { document.getElementById('txAmount').focus(); }, 200);
    }
    function closeTxModal() { document.getElementById('txModal').classList.remove('active'); document.body.style.overflow = ''; document.getElementById('txForm').reset(); }
    document.getElementById('txModal').addEventListener('click', function (e) { if (e.target === this) closeTxModal(); });

    var isTxSubmitting = false;
    function submitTransaction(e) {
        e.preventDefault();
        if (isTxSubmitting) return false;
        isTxSubmitting = true;
        var btn = document.getElementById('txSubmitBtn'); btn.disabled = true; btn.textContent = MSG.processingBtn;
        var type = document.getElementById('txType').value;
        var body = { type: type, amount: parseFloat(document.getElementById('txAmount').value), memo: document.getElementById('txMemo').value.trim() || null };
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        var headers = { 'Content-Type': 'application/json' }; headers[csrfHeader] = csrfToken;
        fetch('/api/account/' + accountId + '/transaction', { method: 'POST', headers: headers, body: JSON.stringify(body) })
        .then(function (r) { return r.json(); })
        .then(function (d) {
            if (d.success) { var msg = type === 'DEPOSIT' ? MSG.depositDone : MSG.withdrawalDone; closeTxModal(); showSuccessAndReload(msg, function () { window.location.reload(); }); }
            else { showAlert(d.message || MSG.txFailed); isTxSubmitting = false; btn.disabled = false; btn.textContent = MSG.confirmBtn; }
        }).catch(function () { showAlert(MSG.serverError); isTxSubmitting = false; btn.disabled = false; btn.textContent = MSG.confirmBtn; });
        return false;
    }

    /* ══ Edit Transaction Modal ══ */
    function openTxEditModal(txId, type, amount, memo) {
        document.getElementById('txEditId').value = txId;
        document.getElementById('txEditType').value = type;
        document.getElementById('txEditAmount').value = amount;
        document.getElementById('txEditMemo').value = memo;
        document.getElementById('txEditSubmitBtn').disabled = false;
        document.getElementById('txEditSubmitBtn').textContent = MSG.saveBtn;
        document.getElementById('txEditModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(function () { document.getElementById('txEditAmount').focus(); }, 200);
    }
    function closeTxEditModal() { document.getElementById('txEditModal').classList.remove('active'); document.body.style.overflow = ''; document.getElementById('txEditForm').reset(); }
    document.getElementById('txEditModal').addEventListener('click', function (e) { if (e.target === this) closeTxEditModal(); });

    var isTxEditSubmitting = false;
    function submitTxEdit(e) {
        e.preventDefault();
        if (isTxEditSubmitting) return false;
        isTxEditSubmitting = true;
        var btn = document.getElementById('txEditSubmitBtn'); btn.disabled = true; btn.textContent = MSG.savingBtn;
        var txId = document.getElementById('txEditId').value;
        var body = { type: document.getElementById('txEditType').value, amount: parseFloat(document.getElementById('txEditAmount').value), memo: document.getElementById('txEditMemo').value.trim() || null };
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        var headers = { 'Content-Type': 'application/json' }; headers[csrfHeader] = csrfToken;
        fetch('/api/account/' + accountId + '/transaction/' + txId, { method: 'PUT', headers: headers, body: JSON.stringify(body) })
        .then(function (r) { return r.json(); })
        .then(function (d) {
            if (d.success) { closeTxEditModal(); showSuccessAndReload(MSG.txUpdated, function () { window.location.reload(); }); }
            else { showAlert(d.message || MSG.txUpdateFailed); isTxEditSubmitting = false; btn.disabled = false; btn.textContent = MSG.saveBtn; }
        }).catch(function () { showAlert(MSG.serverError); isTxEditSubmitting = false; btn.disabled = false; btn.textContent = MSG.saveBtn; });
        return false;
    }

    /* ══ Delete Transaction ══ */
    function deleteTx(txId) {
        showConfirm({ title: MSG.txDeleteTitle, description: MSG.txDeleteDesc, icon: 'danger', confirmText: MSG.deleteBtn, confirmClass: 'danger',
            onConfirm: function () {
                var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                var headers = {}; headers[csrfHeader] = csrfToken;
                fetch('/api/account/' + accountId + '/transaction/' + txId, { method: 'DELETE', headers: headers })
                .then(function (r) { return r.json(); })
                .then(function (d) { if (d.success) { showSuccessAndReload(MSG.txDeleted, function () { window.location.reload(); }); } else { showAlert(d.message || MSG.txDeleteFailed); } })
                .catch(function () { showAlert(MSG.serverError); });
            }
        });
    }

    /* ══ Event Delegation for Table Action Buttons ══ */
    document.addEventListener('click', function (e) {
        var editBtn = e.target.closest('.acd-edit-btn');
        if (editBtn) {
            openTxEditModal(editBtn.dataset.id, editBtn.dataset.type, editBtn.dataset.amount, editBtn.dataset.memo);
            return;
        }
        var deleteBtn = e.target.closest('.acd-delete-btn');
        if (deleteBtn) {
            deleteTx(deleteBtn.dataset.id);
            return;
        }
    });

    /* ── ESC ── */
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            var txEdit = document.getElementById('txEditModal');
            var tx = document.getElementById('txModal');
            var edit = document.getElementById('editAccountModal');
            if (txEdit.classList.contains('active')) closeTxEditModal();
            else if (tx.classList.contains('active')) closeTxModal();
            else if (edit.classList.contains('active')) closeEditModal();
        }
    });
    </script>

</div>
</body>
</html>
